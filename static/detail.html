<!doctype html>
<html lang="ko">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <link rel="stylesheet" type="text/css" href="style.css">

    <!-- jquery -->
    <script src="https://code.jquery.com/jquery-3.5.1.js"
        integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" crossorigin="anonymous"></script>

    <title>항해일지</title>

    <script>
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        const articleId = urlParams.get("articleId");

        $(document).ready(function () {
            getDetail()
            getComments()
        })

        function getDetail() {
            $.ajax({
                type: "GET",
                url: `/api/articles/${articleId}`,
                success: function (response) {
                    const article = response.article

                    const title = article.title
                    const author = article.author
                    const date = article.date
                    const content = article.content

                    $('#title').text(title)
                    $('#author').text(author)
                    $('#date').text(date)
                    $('#content').text(content)
                }
            })
        }

        function toEdit() {
            window.location.href = `/edit.html?articleId=${articleId}`
        }

        function toDelete() {
            const password = prompt("비밀번호를 입력하세요.")
            $.ajax({
                type: "DELETE",
                url: `/api/articles/${articleId}`,
                data: { password },
                success: function (response) {
                    alert(response.message)
                    window.location.href = '/board.html'
                },
                error: function (response) {
                    alert('잘못된 비밀번호 입니다.')
                }
            })
        }

        function getComments() {
            $('#comments').empty()
            $.ajax({
                type: "GET",
                url: `/api/comments/${articleId}`,
                success: function (response) {
                    const comments = response.comments

                    for (const comment of comments) {
                        const author = comment.author
                        const content = comment.content
                        const date = comment.date
                        const commentId = comment._id

                        const temp_html = `<tr id="${commentId}">
                                            <td>${author}</td>
                                            <td>${content}</td>
                                            <td>${date}</td>
                                            <td>
                                                <!--<button type="button" class="btn btn-light">수정</button>-->
                                                <button type="button" class="btn btn-light" onclick="deleteComment('${commentId}')">삭제</button>
                                            </td>
                                        </tr>`
                        $('#comments').append(temp_html)
                    }
                }
            })
        }

        function postComment() {
            const author = $('#comment_author').val()
            const password = $('#comment_password').val()
            const content = $('#comment_content').val()
            $.ajax({
                type: "POST",
                url: "/api/comments",
                data: { author, password, content, articleId },
                success: function (response) {
                    alert(response.message)
                    getComments()
                    $('#comment_author').val('')
                    $('#comment_password').val('')
                    $('#comment_content').val('')
                }
            })
        }

        //  작업중
        // function editComment(commentId) {
        //     $.ajax({
        //         type: "PUT",
        //         url: `/api/comments/${commentId}`,
        //         data: { password, content },
        //         success: function (response) {
        //             alert(response.message)
        //             getComments()
        //         }
        //     })
        // }

        function deleteComment(commentId) {
            const password = prompt('비밀번호를 입력하세요.')
            $.ajax({
                type: "DELETE",
                url: `/api/comments/${commentId}`,
                data: { password },
                success: function (response) {
                    alert(response.message)
                    getComments()
                }
            })
        }

    </script>

</head>

<body>
    <div class="header">
        <a href="/board.html">
            <h1>김정호 항해일지</h1>
        </a>
    </div>

    <!-- Optional JavaScript; choose one of the two! -->

    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>

    <!-- Option 2: Separate Popper and Bootstrap JS -->
    <!--
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js" integrity="sha384-7+zCNj/IqJ95wo16oMtfsKbZ9ccEh31eOz1HGyDuCQ6wgnyJNSYdrPa03rtR1zdB" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js" integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13" crossorigin="anonymous"></script>
    -->

    <div class="container detail_header">
        <div class="row">
            <div class="col-sm title" id="title">
                <!-- 첫 글입니다 -->
            </div>
            <div class="col-sm" id="author">
                <!-- 김정호 -->
            </div>
            <div class="col-sm" id="date">
                <!-- 2022-01-24 -->
            </div>
        </div>
    </div>

    <div class="container" style="margin-top: 15px;">
        <div class="row">
            <div class="col-sm">
                <pre id="content">
                <!-- Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et
                dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip
                ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu
                fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia
                deserunt mollit anim id est laborum. -->
            </pre>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="row">
            <div class="col-sm">
                <table class="table table-striped table-hover">
                    <tbody id="comments">
                        <tr>
                            <td>작성자 1</td>
                            <td>내용 1</td>
                            <td>날짜 1</td>
                            <td>
                                <button type="button" class="btn btn-light">수정</button>
                                <button type="button" class="btn btn-light">삭제</button>
                            </td>
                        </tr>
                        <tr>
                            <td>작성자 2</td>
                            <td>내용 2</td>
                            <td>날짜 2</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="row">
            <div class="col-sm">
                <div class="input-group mb-3">
                    <span class="input-group-text">닉네임</span>
                    <input type="text" class="form-control" placeholder="" aria-label="Username"
                        aria-describedby="basic-addon1" id="comment_author">
                </div>
            </div>
            <div class="col-sm">
                <div class="input-group mb-3">
                    <span class="input-group-text">비밀번호</span>
                    <input type="text" class="form-control" placeholder="" aria-label="Username"
                        aria-describedby="basic-addon1" id="comment_password">
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="row">
            <div class="col-sm">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" placeholder="댓글을 입력해주세요." aria-label="Recipient's username"
                        aria-describedby="button-addon2" id="comment_content">
                    <button class="btn btn-outline-secondary" type="button" id="button-addon2" onclick="postComment()">등록</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container detail_buttons">
        <div class="row">
            <div class="col-sm" style="margin-top: 15px;">
                <button type="button" class="btn btn-dark" onclick="toEdit()">수정</button>
                <button type="button" class="btn btn-dark" onclick="toDelete()">삭제</button>
            </div>
        </div>
    </div>

</body>

</html>